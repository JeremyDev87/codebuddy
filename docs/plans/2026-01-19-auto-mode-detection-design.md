# PLAN/ACT/EVAL 패턴 자동 감지 설계

## 개요

사용자가 "PLAN:", "ACT:", "EVAL:", "AUTO:" 패턴으로 메시지를 시작할 때 자동으로 `parse_mode` MCP 함수를 호출하도록 하는 기능 설계.

## 문제점

- 현재 `/plan`, `/act`, `/eval` 명령어로만 모드 전환 가능
- "PLAN: something" 형태의 자연스러운 입력이 인식되지 않음
- CLAUDE.md에 지시사항이 있으나 일관성 없이 동작

## 해결 방안: UserPromptSubmit Hook + SessionStart 자동 설치

### 아키텍처

```
┌─────────────────────────────────────────────────────────────────┐
│                    Claude Code 세션 시작                         │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                 SessionStart Hook 실행                          │
│  (플러그인의 hooks/session-start.py)                            │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  1. ~/.claude/hooks/ 디렉토리 존재 확인                    │  │
│  │  2. codingbuddy-mode-detect.py 존재 확인                  │  │
│  │  3. 없으면 → 플러그인에서 복사 & 권한 설정                  │  │
│  │  4. ~/.claude/settings.json 훅 설정 확인/추가              │  │
│  │  5. 결과 메시지 출력 (설치됨/이미 존재)                     │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                        사용자 입력                               │
│              "PLAN: 리뷰 수집 로직 변경하고 싶어"                  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                   UserPromptSubmit Hook                         │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  1. stdin으로 JSON 입력 받음                               │  │
│  │  2. prompt 필드에서 패턴 감지                              │  │
│  │     - PLAN|ACT|EVAL|AUTO (영문)                           │  │
│  │     - 계획|실행|평가|자동 (한글)                            │  │
│  │     - 計画|実行|評価|自動 (일본어)                          │  │
│  │     - 计划|执行|评估|自动 (중국어)                          │  │
│  │     - PLANIFICAR|ACTUAR|EVALUAR|AUTOMÁTICO (스페인어)      │  │
│  │  3. 감지 시 JSON 컨텍스트 출력                             │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                     Claude 처리                                  │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  주입된 컨텍스트를 보고 parse_mode MCP 호출                 │  │
│  │  → CodingBuddy MCP Server가 모드별 지시사항 반환            │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

## 파일 구조

```
codingbuddy/ (플러그인 루트)
├── .claude-plugin/
│   └── plugin.json              ← hooks 필드 추가
├── commands/
│   ├── plan.md
│   ├── act.md
│   ├── eval.md
│   └── auto.md
├── hooks/                        ← 신규 디렉토리
│   ├── session-start.py          ← SessionStart: 자동 설치
│   └── user-prompt-submit.py     ← UserPromptSubmit: 패턴 감지
├── README.md                     ← 설치 가이드 업데이트
└── package.json
```

## 다국어 패턴 지원

| Mode | 영어 | 한국어 | 일본어 | 중국어 | 스페인어 |
|------|------|--------|--------|--------|----------|
| PLAN | PLAN | 계획 | 計画 | 计划 | PLANIFICAR |
| ACT | ACT | 실행 | 実行 | 执行 | ACTUAR |
| EVAL | EVAL | 평가 | 評価 | 评估 | EVALUAR |
| AUTO | AUTO | 자동 | 自動 | 自动 | AUTOMÁTICO |

## 구현 세부사항

### 1. user-prompt-submit.py

- 정규식으로 시작 부분만 체크 (성능)
- 대소문자 무시 (`re.IGNORECASE`)
- XML 태그로 컨텍스트 래핑 (파싱 용이)
- 감지 안 되면 아무것도 출력 안 함

### 2. session-start.py

- 플러그인 경로 탐색: 환경변수 → fallback 경로들
- ~/.claude/hooks/ 에 스크립트 복사
- ~/.claude/settings.json 에 훅 등록
- 이미 설치된 경우 스킵

### 3. plugin.json

```json
{
  "name": "codingbuddy",
  "hooks": {
    "SessionStart": "hooks/session-start.py"
  }
}
```

## 테스트 계획

1. **단위 테스트** (user-prompt-submit.py)
   - 영문 키워드 감지
   - 한글 키워드 감지
   - 대소문자 무시
   - 콜론 없는 경우
   - 키워드 없는 경우

2. **통합 테스트** (session-start.py)
   - 첫 설치 시 hooks 디렉토리 생성
   - 중복 설치 방지
   - settings.json 기존 설정 유지

3. **E2E 테스트**
   - 플러그인 설치 → 세션 시작 → 훅 설치 확인
   - "PLAN: 테스트" 입력 → parse_mode 호출 확인

## 완료 기준

- [ ] 모든 다국어 키워드 (영/한/일/중/스페인어) 감지
- [ ] SessionStart에서 자동 설치 성공
- [ ] settings.json 기존 설정 손상 없음
- [ ] parse_mode MCP 호출 정상 동작
